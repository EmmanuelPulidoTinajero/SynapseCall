<div class="dashboard-container" style="max-width: 1000px; margin: 0 auto; padding: 20px;">
    
    <div class="header-section" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <div>
            <h1>Hola, {{user.name}} <span style="font-size: 0.8rem; background: {{#if user.isPro}}#ffd700{{else}}#ccc{{/if}}; padding: 2px 6px; border-radius: 4px;">{{#if user.isPro}}PRO{{else}}FREE{{/if}}</span></h1>
            <p>Bienvenido a tu panel de control.</p>
        </div>
        <div>
            <form action="/auth/logout" method="POST" style="display: inline;">
                <button type="submit" style="background: none; border: 1px solid #dc3545; color: #dc3545; padding: 5px 10px; cursor: pointer; border-radius: 4px;">Cerrar Sesi√≥n</button>
            </form>
        </div>
    </div>

    <div class="org-section" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px; border: 1px solid #e9ecef;">
        
        {{#if organization}}
            <div class="org-display" style="display: flex; align-items: center; gap: 20px;">
                {{#if organization.logoUrl}}
                    <img src="{{organization.logoUrl}}" alt="Org Logo" style="width: 80px; height: 80px; object-fit: cover; border-radius: 50%; border: 2px solid #ddd;">
                {{else}}
                    <div style="width: 80px; height: 80px; background: #ddd; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem;">üè¢</div>
                {{/if}}
                
                <div>
                    <h2 style="margin: 0;">{{organization.name}}</h2>
                    <p style="color: green; font-weight: bold; margin: 5px 0;">Organizaci√≥n Activa</p>
                </div>
            </div>

            {{#if organization.isOwner}}
                <div class="org-admin" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd;">
                    <h3>Gesti√≥n de Miembros</h3>
                    <p style="font-size: 0.9rem; color: #666;">Tienes acceso a invitar hasta 10 miembros a tu equipo.</p>
                    
                    <input type="hidden" id="current-org-id" value="{{organization.id}}">

                    <form id="invite-member-form" style="display: flex; gap: 10px; margin-top: 10px;">
                        <input type="email" id="invite-email" placeholder="Correo del usuario a invitar" required style="flex: 1; padding: 8px;">
                        <button type="submit" style="background: #28a745; color: white; border: none; padding: 8px 15px; cursor: pointer; border-radius: 4px;">Agregar Miembro</button>
                    </form>
                    <div id="invite-message" style="margin-top: 5px; font-size: 0.9rem;"></div>
                </div>
            {{/if}}

        {{else}}
            <div class="create-org-wrapper">
                <h2>Crea tu Organizaci√≥n</h2>
                <p>Desbloquea funciones PRO, Agenda y Branding para ti y tu equipo por solo <strong>$5.00 USD/mes</strong>.</p>
                
                <div style="margin-top: 20px; max-width: 500px;">
                    <label for="org-name-input" style="display: block; margin-bottom: 5px; font-weight: bold;">Nombre de la Empresa:</label>
                    <input type="text" id="org-name-input" placeholder="Ej. Soluciones Inclusivas" style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px;">
                    
                    <label for="org-logo-input" style="display: block; margin-bottom: 5px; font-weight: bold;">Logo (Opcional):</label>
                    <input type="file" id="org-logo-input" accept="image/*" style="margin-bottom: 20px;">

                    <div id="paypal-button-container"></div>
                </div>
            </div>
        {{/if}}
    </div>

    <div class="quick-actions" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
        <div class="card" style="border: 1px solid #ddd; padding: 20px; border-radius: 8px;">
            <h3>üìπ Nueva Reuni√≥n</h3>
            <p>Crea una sala instant√°nea.</p>
            <form id="create-meeting-form">
                <input type="text" id="meeting-title" placeholder="T√≠tulo de la reuni√≥n" required style="width: 100%; padding: 8px; margin-bottom: 10px;">
                <button type="submit" class="btn-primary" style="width: 100%;">Crear Reuni√≥n</button>
            </form>
        </div>

        <div class="card" style="border: 1px solid #ddd; padding: 20px; border-radius: 8px;">
            <h3>üîó Unirse a Reuni√≥n</h3>
            <p>Ingresa el c√≥digo o ID.</p>
            <input type="text" id="join-id" placeholder="ID de la reuni√≥n" style="width: 100%; padding: 8px; margin-bottom: 10px;">
            <button onclick="window.location.href='/meetings/' + document.getElementById('join-id').value" style="width: 100%; padding: 8px; background: #6c757d; color: white; border: none; cursor: pointer; border-radius: 4px;">Unirse</button>
        </div>
    </div>
</div>

{{#unless organization}}
<script src="https://www.paypal.com/sdk/js?client-id={{paypalClientId}}&currency=USD"></script>
<script>
    
    paypal.Buttons({
        
        onInit: function(data, actions) {
            actions.disable();
            document.getElementById('org-name-input').addEventListener('input', function(event) {
                if (event.target.value.length > 0) {
                    actions.enable();
                } else {
                    actions.disable();
                }
            });
        },
        onClick: function() {
            if (document.getElementById('org-name-input').value.length === 0) {
                alert("Por favor ingresa un nombre para tu organizaci√≥n primero.");
            }
        },
        // Configura la transacci√≥n
        createOrder: function(data, actions) {
            return actions.order.create({
                purchase_units: [{
                    amount: {
                        value: '5.00' // EL PRECIO DE LA ORG
                    },
                    description: "Suscripci√≥n Organizaci√≥n SynapseCall"
                }]
            });
        },
        
        onApprove: async function(data, actions) {
            
            const order = await actions.order.capture();
            const orderId = order.id;
            const orgName = document.getElementById('org-name-input').value;
            const fileInput = document.getElementById('org-logo-input');
            

            const formData = new FormData();
            formData.append('name', orgName);
            formData.append('orderId', orderId); // Enviamos el ID para validaci√≥n
            if (fileInput.files[0]) {
                formData.append('file', fileInput.files[0]);
            }

            
            try {
                const response = await fetch('/organizations/create', {
                    method: 'POST',
                    
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    alert('¬°Organizaci√≥n Creada! ' + result.message);
                    window.location.reload(); // Recargar para ver el dashboard actualizado
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error(error);
                alert('Error de conexi√≥n al crear la organizaci√≥n.');
            }
        }
    }).render('#paypal-button-container');
</script>
{{/unless}}

<script>
    
    document.getElementById('create-meeting-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const title = document.getElementById('meeting-title').value;
        const startTime = new Date().toISOString(); // Iniciar ahora

        try {
            const res = await fetch('/meetings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    title, 
                    description: "Reuni√≥n r√°pida", 
                    status: "ongoing", 
                    startTime 
                })
            });
            const data = await res.json();
            if (res.ok) {
                const meetingId = data.meeting._id || data.meeting.id;
                window.location.href = `/meetings/${meetingId}`;
            } else {
                alert('Error al crear reuni√≥n: ' + data.message);
            }
        } catch (error) {
            console.error(error);
        }
    });

    
    const inviteForm = document.getElementById('invite-member-form');
    if (inviteForm) {
        inviteForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('invite-email').value;
            
            const orgId = document.getElementById('current-org-id').value;
            const msgDiv = document.getElementById('invite-message');
            msgDiv.textContent = "Enviando invitaci√≥n...";

            try {
                
                const res = await fetch(`/organizations/${orgId}/members`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const data = await res.json();
                if (res.ok) {
                    msgDiv.textContent = "‚úÖ " + data.message;
                    msgDiv.style.color = "green";
                    document.getElementById('invite-email').value = "";
                } else {
                    msgDiv.textContent = "‚ùå " + data.message;
                    msgDiv.style.color = "red";
                }
            } catch (error) {
                console.error(error);
                msgDiv.textContent = "Error de conexi√≥n";
            }
        });
    }
</script>