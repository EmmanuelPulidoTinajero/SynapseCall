<div>
  <div id="video-grid"></div>
</div>
<div id="space"></div>
<div>
  <form id="file-upload-form" action="/meetings/{{meetingId}}/uploadFiles" method="post" enctype="multipart/form-data">
    <div>
      <input type="file" name="file" id="file-input">
    </div>
    <div>
      <button type="submit" id="upload-button">Upload</button>
    </div>
  </form>
</div>
<div id="chat-container" style="margin-top: 16px;">
  <h3>Chat de la reuniÃ³n</h3>
  <div id="chat-messages"
       style="height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 8px; margin-bottom: 8px;">
  </div>
  <form id="chat-form">
    <input id="chat-input" type="text" placeholder="Escribe aquÃ­..." style="width: 80%;" />
    <button type="submit">Enviar</button>
  </form>
</div>

<script>
  const MEETING_ID = "{{meetingId}}";
  const keys = {{{downloadLinksJson}}};
  const ICE_SERVERS = {{{iceServersJson}}};

  const chatMessagesContainer = document.getElementById("chat-messages");

  function addFileToChat(fileData) {
      const url = fileData.url;
      const key = fileData.key || '';
      const originalName = fileData.originalName || key.split('---').pop() || 'Archivo';

      const messageElement = document.createElement("div");
      messageElement.style.margin = "5px 0";
      messageElement.innerHTML = `
        <strong>Sistema:</strong> Ha compartido un archivo: <br/>
        <a href="${url}" download target="_blank" rel="noopener noreferrer" style="color: blue; text-decoration: underline;">
            ðŸ“¥ Descargar ${originalName}
        </a>
      `;

      chatMessagesContainer.appendChild(messageElement);
      chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
  }

  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('file-upload-form');
    const fileInput = document.getElementById('file-input');
    const uploadButton = document.getElementById('upload-button');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (fileInput.files.length === 0) {
            alert('Please select a file to upload.');
            return;
        }

        const formData = new FormData(form);
        uploadButton.disabled = true;
        uploadButton.textContent = 'Uploading...';

        try {
            const response = await fetch(form.action, {
                method: 'POST',
                body: formData,
            });

            if (response.ok) {
                const data = await response.json();
            } else {
                alert('Upload failed. Status: ' + response.status);
            }
        } catch (error) {
            alert('An error occurred during upload.');
        } finally {
            uploadButton.disabled = false;
            uploadButton.textContent = 'Upload';
            form.reset();
        }
    });

    if (typeof socket !== 'undefined') {
        socket.on('file-uploaded', (fileData) => {
            addFileToChat(fileData);
        });
    }
});
</script>